{"ast":null,"code":"import{jsxs as _jsxs}from\"react/jsx-runtime\";import _toConsumableArray from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import{jsx as _jsx}from\"react/jsx-runtime\";import _regeneratorRuntime from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _asyncIterator from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncIterator\";import React,{useState,useEffect}from'react';import{getCookie}from'../../../helpers/auth';import socketApp from'../../../socket';import IconButton from'@material-ui/core/IconButton';import\"../../style/call.css\";import VolumeMuteIcon from'@material-ui/icons/VolumeMute';import VolumeUpIcon from'@material-ui/icons/VolumeUp';import VolumeOffIcon from'@material-ui/icons/VolumeOff';import{createEmptyAudioTrack}from'../../../helpers/audio';import SimpleMenu from'../miniChatCom/simpleMenu';import MicIcon from'@material-ui/icons/Mic';import MicOffIcon from'@material-ui/icons/MicOff';import hark from\"hark\";import RenderChat from'../renderChat';// This function is use for send and view message\nfunction ChatGroup(props){var userId=getCookie().token;var socket=socketApp.getSocket();var id=props.id,peerJS=props.peerJS;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),audio=_useState2[0],setAudio=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),mic=_useState4[0],setMic=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),volumn=_useState6[0],setVolumn=_useState6[1];var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),oldPeer=_useState8[0],setOldPeer=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),talk=_useState10[0],setTalk=_useState10[1];// turn on or turn off own volumn\nvar handleSetVolumn=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var arr,_iteratorNormalCompletion,_didIteratorError,_iteratorError,_iterator,_step,_value,data,value,old,obj;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(audio.length!==0)){_context.next=46;break;}setVolumn(!volumn);arr=[];_iteratorNormalCompletion=true;_didIteratorError=false;_context.prev=5;_iterator=_asyncIterator(audio);case 7:_context.next=9;return _iterator.next();case 9:_step=_context.sent;_iteratorNormalCompletion=_step.done;_context.next=13;return _step.value;case 13:_value=_context.sent;if(_iteratorNormalCompletion){_context.next=29;break;}data=_value;// copy old object\nvalue=Object.assign({},data.stream.props,{seleted:false,writeable:true});old=Object.assign({},data.stream,{writeable:true,seleted:false});value.muted=!volumn;// delete specific key\ndelete value[\"seleted\"];delete value[\"writeable\"];old.props=value;delete old[\"seleted\"];delete old[\"writeable\"];// create new object\n// to handle new data\nobj={stream:old,audio:data.audio,mic:false};arr.push(obj);case 26:_iteratorNormalCompletion=true;_context.next=7;break;case 29:_context.next=35;break;case 31:_context.prev=31;_context.t0=_context[\"catch\"](5);_didIteratorError=true;_iteratorError=_context.t0;case 35:_context.prev=35;_context.prev=36;if(!(!_iteratorNormalCompletion&&_iterator.return!=null)){_context.next=40;break;}_context.next=40;return _iterator.return();case 40:_context.prev=40;if(!_didIteratorError){_context.next=43;break;}throw _iteratorError;case 43:return _context.finish(40);case 44:return _context.finish(35);case 45:setAudio(arr);case 46:case\"end\":return _context.stop();}}},_callee,null,[[5,31,35,45],[36,,40,44]]);}));return function handleSetVolumn(){return _ref.apply(this,arguments);};}();// Turn on or turn off the own mic\nvar handleSetMic=function handleSetMic(){setMic(!mic);if(mic===true){var audioTrack=createEmptyAudioTrack();var data=oldPeer.connections;for(var i=0;i<audio.length;i++){var userMic=Object.keys(data)[i];var sender=data[userMic][0].peerConnection.getSenders()[0]||[];sender.replaceTrack(audioTrack);}}// else reconnect peer to peer \nelse{navigator.mediaDevices.getUserMedia({video:false,audio:true}).then(function(stream){var data=oldPeer.connections;for(var _i=0;_i<audio.length;_i++){var _userMic=Object.keys(data)[_i];var _sender=data[_userMic][0].peerConnection.getSenders()[0];_sender.replaceTrack(stream.getAudioTracks()[0]);}}).catch(function(err){});}};var handleSetVolumnOther=function handleSetVolumnOther(value,i){// get id the user want to muted\nvar idMuted=Object.keys(oldPeer.connections)[i];var sender=oldPeer.connections[idMuted][0].peerConnection.getSenders()[0]||[];var returnAudio=function returnAudio(stream,streamNull){var a=/*#__PURE__*/_jsx(\"audio\",{ref:function ref(audio){return audio?audio.srcObject=stream:streamNull;},playsInline:true,autoPlay:true});var obj={stream:a,audio:false,mic:true};var arr=_toConsumableArray(audio);arr[i]=obj;setAudio(arr);};if(value.audio===true){var audioTrack=createEmptyAudioTrack();sender.replaceTrack(audioTrack);var streamNull=new MediaStream([audioTrack]);returnAudio(streamNull,streamNull);}else{navigator.mediaDevices.getUserMedia({video:false,audio:true}).then(function(stream){sender.replaceTrack(stream.getAudioTracks()[0]);returnAudio(stream,createNullStream());});}};var handleSetMicOther=function handleSetMicOther(data,i){if(audio.length!==0){// copy old object\nvar value=Object.assign({},data.stream.props,{seleted:false,writeable:true});var old=Object.assign({},data.stream,{writeable:true,seleted:false});value.muted=!volumn;// delete specific key\ndelete value[\"seleted\"];delete value[\"writeable\"];old.props=value;delete old[\"seleted\"];delete old[\"writeable\"];// create new object\n// to handle new data\nvar arr=_toConsumableArray(audio);var obj={stream:old,audio:data.audio,mic:false};arr[i]=obj;setAudio(arr);}};// create null stream to handle error \nvar createNullStream=function createNullStream(){var _audioStream=function audioStream(){try{var audioTrack=createEmptyAudioTrack();var streamNull=new MediaStream([audioTrack]);return _audioStream=/*#__PURE__*/_jsx(\"audio\",{muted:true,ref:function ref(audio){return audio.srcObject=streamNull;},playsInline:true,autoPlay:true});}catch(error){return;}};return _audioStream();};// new user go to the room\nvar createCall=function createCall(call){call.on(\"stream\",/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(userVideoStream){var audioStream,a,obj;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:audioStream=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var audioTrack,streamNull,speechEvents,_a,_obj;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:audioTrack=createEmptyAudioTrack();streamNull=new MediaStream([audioTrack]);_context2.prev=2;speechEvents=hark(userVideoStream,{});speechEvents.on('speaking',function(){setTalk(true);});speechEvents.on('stopped_speaking',function(){setTalk(false);});return _context2.abrupt(\"return\",/*#__PURE__*/_jsx(\"audio\",{playsInline:true,muted:false,ref:function ref(audio){return audio?audio.srcObject=userVideoStream:streamNull;},autoPlay:true}));case 9:_context2.prev=9;_context2.t0=_context2[\"catch\"](2);_a=createNullStream();_obj={stream:_a,audio:false,mic:false};setAudio(function(value){return[].concat(_toConsumableArray(value),[_obj]);});case 14:case\"end\":return _context2.stop();}}},_callee2,null,[[2,9]]);}));return function audioStream(){return _ref3.apply(this,arguments);};}();_context3.next=3;return audioStream();case 3:a=_context3.sent;obj={stream:a,audio:true,mic:true};setAudio(function(value){return[].concat(_toConsumableArray(value),[obj]);});case 6:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x){return _ref2.apply(this,arguments);};}());};// fisrt route of connect peer to peer \nvar plus=function plus(peer,stream){// check if that peer is destroyed or not destroy that mean that was created before\nif(peer.destroyed===false){// run normally\npeer.on(\"call\",function(call){call.answer(stream);createCall(call);});// recieve from server\nsocket.on(\"user-connect\",function(value){if(value.idRoom===id){var call=peer.call(value.id,stream);createCall(call);}});}};useEffect(function(){var fn=function fn(){setOldPeer(peerJS);peerJS.on(\"open\",function(){socket.emit(\"chatVideo\",{idRoom:id,id:userId,g:\"a\"},function(callback){});});// get user media\nnavigator.mediaDevices.getUserMedia({video:false,audio:mic}).then(function(stream){plus(peerJS,stream);}).catch(function(err){// if user does not accept to stream then create new null stream\nvar audioTrack=createEmptyAudioTrack();var stream=new MediaStream([audioTrack]);plus(peerJS,stream);});};fn();},[id,peerJS]);return/*#__PURE__*/_jsxs(\"div\",{className:\"message_container\",children:[/*#__PURE__*/_jsx(RenderChat,{id:props.id,userId:userId}),/*#__PURE__*/_jsxs(\"div\",{className:\"call_div_container\",children:[/*#__PURE__*/_jsx(SimpleMenu,{onClick:function onClick(value){return props.onClick(value);}}),/*#__PURE__*/_jsxs(\"div\",{className:\"main_mic\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"Voice Chat\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"user_device\",children:[/*#__PURE__*/_jsx(\"img\",{alt:\"demom\",style:talk===true?{border:\"2px solid rgba(46, 229, 157, 0.4)\"}:{},src:\"../demo.jpeg\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"icon_device\",children:[/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(e){return handleSetMic();},children:mic===true?/*#__PURE__*/_jsx(MicIcon,{}):/*#__PURE__*/_jsx(MicOffIcon,{})}),/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(e){return handleSetVolumn();},children:volumn===false?talk===true?/*#__PURE__*/_jsx(VolumeUpIcon,{}):/*#__PURE__*/_jsx(VolumeMuteIcon,{}):/*#__PURE__*/_jsx(VolumeOffIcon,{})})]})]}),audio.length>0?audio.map(function(value,i){return/*#__PURE__*/_jsxs(\"div\",{className:\"user_device\",children:[/*#__PURE__*/_jsx(\"img\",{alt:\"demom\",style:talk===true?{border:\"2px solid rgba(46, 229, 157, 0.4)\"}:{},src:\"../demo.jpeg\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"icon_device\",children:[value.stream,value.mic,/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(e){return handleSetMicOther(value,i);},children:value.mic===true?/*#__PURE__*/_jsx(MicIcon,{}):/*#__PURE__*/_jsx(MicOffIcon,{})}),/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(e){return handleSetVolumnOther(value,i);},children:value.audio===true?talk===true?/*#__PURE__*/_jsx(VolumeUpIcon,{}):/*#__PURE__*/_jsx(VolumeMuteIcon,{}):/*#__PURE__*/_jsx(VolumeOffIcon,{})})]})]},i);}):console.log()]})]})]});}export default ChatGroup;","map":{"version":3,"sources":["/home/duythai/Developer/sadness/a-client/src/component/chatComponent/miniChatCom/chatGroup.js"],"names":["React","useState","useEffect","getCookie","socketApp","IconButton","VolumeMuteIcon","VolumeUpIcon","VolumeOffIcon","createEmptyAudioTrack","SimpleMenu","MicIcon","MicOffIcon","hark","RenderChat","ChatGroup","props","userId","token","socket","getSocket","id","peerJS","audio","setAudio","mic","setMic","volumn","setVolumn","oldPeer","setOldPeer","talk","setTalk","handleSetVolumn","length","arr","data","value","Object","assign","stream","seleted","writeable","old","muted","obj","push","handleSetMic","audioTrack","connections","i","userMic","keys","sender","peerConnection","getSenders","replaceTrack","navigator","mediaDevices","getUserMedia","video","then","getAudioTracks","catch","err","handleSetVolumnOther","idMuted","returnAudio","streamNull","a","srcObject","MediaStream","createNullStream","handleSetMicOther","audioStream","error","createCall","call","on","userVideoStream","speechEvents","plus","peer","destroyed","answer","idRoom","fn","emit","g","callback","onClick","border","e","map","console","log"],"mappings":"w3BAAA,MAAOA,CAAAA,KAAP,EAAgBC,QAAhB,CAA0BC,SAA1B,KAA2C,OAA3C,CACA,OAASC,SAAT,KAA0B,uBAA1B,CACA,MAAOC,CAAAA,SAAP,KAAsB,iBAAtB,CACA,MAAOC,CAAAA,UAAP,KAAuB,8BAAvB,CACA,MAAO,sBAAP,CACA,MAAOC,CAAAA,cAAP,KAA2B,+BAA3B,CACA,MAAOC,CAAAA,YAAP,KAAyB,6BAAzB,CACA,MAAOC,CAAAA,aAAP,KAA0B,8BAA1B,CACA,OAASC,qBAAT,KAAsC,wBAAtC,CACA,MAAOC,CAAAA,UAAP,KAAuB,2BAAvB,CACA,MAAOC,CAAAA,OAAP,KAAoB,wBAApB,CACA,MAAOC,CAAAA,UAAP,KAAuB,2BAAvB,CACA,MAAOC,CAAAA,IAAP,KAAiB,MAAjB,CACA,MAAOC,CAAAA,UAAP,KAAuB,eAAvB,CAEA;AACA,QAASC,CAAAA,SAAT,CAAmBC,KAAnB,CAA0B,CACtB,GAAMC,CAAAA,MAAM,CAAGd,SAAS,GAAGe,KAA3B,CACA,GAAIC,CAAAA,MAAM,CAAGf,SAAS,CAACgB,SAAV,EAAb,CAFsB,GAGdC,CAAAA,EAHc,CAGCL,KAHD,CAGdK,EAHc,CAGVC,MAHU,CAGCN,KAHD,CAGVM,MAHU,eAIIrB,QAAQ,CAAC,EAAD,CAJZ,wCAIfsB,KAJe,eAIRC,QAJQ,8BAKAvB,QAAQ,CAAC,KAAD,CALR,yCAKfwB,GALe,eAKVC,MALU,8BAMMzB,QAAQ,CAAC,KAAD,CANd,yCAMf0B,MANe,eAMPC,SANO,8BAOQ3B,QAAQ,CAAC,IAAD,CAPhB,yCAOf4B,OAPe,eAONC,UAPM,8BAQE7B,QAAQ,CAAC,KAAD,CARV,0CAQf8B,IARe,gBAQTC,OARS,gBAStB;AACA,GAAMC,CAAAA,eAAe,0FAAG,qPAEhBV,KAAK,CAACW,MAAN,GAAiB,CAFD,2BAGhBN,SAAS,CAAC,CAACD,MAAF,CAAT,CACIQ,GAJY,CAIN,EAJM,iGAKOZ,KALP,wOAKDa,IALC,QAMZ;AACIC,KAPQ,CAOAC,MAAM,CAACC,MAAP,CAAc,EAAd,CAAkBH,IAAI,CAACI,MAAL,CAAYxB,KAA9B,CAAqC,CAAEyB,OAAO,CAAE,KAAX,CAAkBC,SAAS,CAAE,IAA7B,CAArC,CAPA,CAQRC,GARQ,CAQFL,MAAM,CAACC,MAAP,CAAc,EAAd,CAAkBH,IAAI,CAACI,MAAvB,CAA+B,CAAEE,SAAS,CAAE,IAAb,CAAmBD,OAAO,CAAE,KAA5B,CAA/B,CARE,CASZJ,KAAK,CAACO,KAAN,CAAc,CAACjB,MAAf,CACA;AACA,MAAOU,CAAAA,KAAK,CAAC,SAAD,CAAZ,CACA,MAAOA,CAAAA,KAAK,CAAC,WAAD,CAAZ,CACAM,GAAG,CAAC3B,KAAJ,CAAYqB,KAAZ,CACA,MAAOM,CAAAA,GAAG,CAAC,SAAD,CAAV,CACA,MAAOA,CAAAA,GAAG,CAAC,WAAD,CAAV,CACA;AACA;AACIE,GAlBQ,CAkBF,CACNL,MAAM,CAAEG,GADF,CAENpB,KAAK,CAAEa,IAAI,CAACb,KAFN,CAGNE,GAAG,CAAE,KAHC,CAlBE,CAuBZU,GAAG,CAACW,IAAJ,CAASD,GAAT,EAvBY,0hBAyBhBrB,QAAQ,CAACW,GAAD,CAAR,CAzBgB,uFAAH,kBAAfF,CAAAA,eAAe,0CAArB,CA4BA;AACA,GAAMc,CAAAA,YAAY,CAAG,QAAfA,CAAAA,YAAe,EAAM,CACvBrB,MAAM,CAAC,CAACD,GAAF,CAAN,CACA,GAAIA,GAAG,GAAK,IAAZ,CAAkB,CACd,GAAMuB,CAAAA,UAAU,CAAGvC,qBAAqB,EAAxC,CACA,GAAI2B,CAAAA,IAAI,CAAGP,OAAO,CAACoB,WAAnB,CACA,IAAK,GAAIC,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAG3B,KAAK,CAACW,MAA1B,CAAkCgB,CAAC,EAAnC,CAAuC,CACnC,GAAIC,CAAAA,OAAO,CAAGb,MAAM,CAACc,IAAP,CAAYhB,IAAZ,EAAkBc,CAAlB,CAAd,CACA,GAAIG,CAAAA,MAAM,CAAGjB,IAAI,CAACe,OAAD,CAAJ,CAAc,CAAd,EAAiBG,cAAjB,CAAgCC,UAAhC,GAA6C,CAA7C,GAAmD,EAAhE,CACAF,MAAM,CAACG,YAAP,CAAoBR,UAApB,EACH,CACJ,CACD;AATA,IAUK,CACDS,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC,CAAEC,KAAK,CAAE,KAAT,CAAgBrC,KAAK,CAAE,IAAvB,CAApC,EAAmEsC,IAAnE,CAAwE,SAAArB,MAAM,CAAI,CAC9E,GAAIJ,CAAAA,IAAI,CAAGP,OAAO,CAACoB,WAAnB,CACA,IAAK,GAAIC,CAAAA,EAAC,CAAG,CAAb,CAAgBA,EAAC,CAAG3B,KAAK,CAACW,MAA1B,CAAkCgB,EAAC,EAAnC,CAAuC,CACnC,GAAIC,CAAAA,QAAO,CAAGb,MAAM,CAACc,IAAP,CAAYhB,IAAZ,EAAkBc,EAAlB,CAAd,CACA,GAAIG,CAAAA,OAAM,CAAGjB,IAAI,CAACe,QAAD,CAAJ,CAAc,CAAd,EAAiBG,cAAjB,CAAgCC,UAAhC,GAA6C,CAA7C,CAAb,CACAF,OAAM,CAACG,YAAP,CAAoBhB,MAAM,CAACsB,cAAP,GAAwB,CAAxB,CAApB,EACH,CACJ,CAPD,EAOGC,KAPH,CAOS,SAAAC,GAAG,CAAI,CACf,CARD,EASH,CACJ,CAvBD,CAwBA,GAAMC,CAAAA,oBAAoB,CAAG,QAAvBA,CAAAA,oBAAuB,CAAC5B,KAAD,CAAQa,CAAR,CAAc,CACvC;AACA,GAAIgB,CAAAA,OAAO,CAAG5B,MAAM,CAACc,IAAP,CAAYvB,OAAO,CAACoB,WAApB,EAAiCC,CAAjC,CAAd,CACA,GAAIG,CAAAA,MAAM,CAAGxB,OAAO,CAACoB,WAAR,CAAoBiB,OAApB,EAA6B,CAA7B,EAAgCZ,cAAhC,CAA+CC,UAA/C,GAA4D,CAA5D,GAAkE,EAA/E,CACA,GAAMY,CAAAA,WAAW,CAAG,QAAdA,CAAAA,WAAc,CAAC3B,MAAD,CAAS4B,UAAT,CAAwB,CACxC,GAAIC,CAAAA,CAAC,cACD,cAAO,GAAG,CAAE,aAAA9C,KAAK,QAAIA,CAAAA,KAAK,CAAGA,KAAK,CAAC+C,SAAN,CAAkB9B,MAArB,CAA8B4B,UAAvC,EAAjB,CAAoE,WAAW,KAA/E,CAAgF,QAAQ,KAAxF,EADJ,CAGA,GAAIvB,CAAAA,GAAG,CAAG,CACNL,MAAM,CAAE6B,CADF,CAEN9C,KAAK,CAAE,KAFD,CAGNE,GAAG,CAAE,IAHC,CAAV,CAKA,GAAIU,CAAAA,GAAG,oBAAOZ,KAAP,CAAP,CACAY,GAAG,CAACe,CAAD,CAAH,CAASL,GAAT,CACArB,QAAQ,CAACW,GAAD,CAAR,CACH,CAZD,CAaA,GAAIE,KAAK,CAACd,KAAN,GAAgB,IAApB,CAA0B,CACtB,GAAIyB,CAAAA,UAAU,CAAGvC,qBAAqB,EAAtC,CACA4C,MAAM,CAACG,YAAP,CAAoBR,UAApB,EACA,GAAMoB,CAAAA,UAAU,CAAG,GAAIG,CAAAA,WAAJ,CAAgB,CAACvB,UAAD,CAAhB,CAAnB,CACAmB,WAAW,CAACC,UAAD,CAAaA,UAAb,CAAX,CACH,CALD,IAKO,CACHX,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC,CAAEC,KAAK,CAAE,KAAT,CAAgBrC,KAAK,CAAE,IAAvB,CAApC,EAAmEsC,IAAnE,CAAwE,SAAArB,MAAM,CAAI,CAC9Ea,MAAM,CAACG,YAAP,CAAoBhB,MAAM,CAACsB,cAAP,GAAwB,CAAxB,CAApB,EACAK,WAAW,CAAC3B,MAAD,CAASgC,gBAAgB,EAAzB,CAAX,CACH,CAHD,EAIH,CACJ,CA5BD,CA6BA,GAAMC,CAAAA,iBAAiB,CAAG,QAApBA,CAAAA,iBAAoB,CAACrC,IAAD,CAAOc,CAAP,CAAa,CACnC,GAAI3B,KAAK,CAACW,MAAN,GAAiB,CAArB,CAAwB,CACpB;AACA,GAAIG,CAAAA,KAAK,CAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,CAAkBH,IAAI,CAACI,MAAL,CAAYxB,KAA9B,CAAqC,CAAEyB,OAAO,CAAE,KAAX,CAAkBC,SAAS,CAAE,IAA7B,CAArC,CAAZ,CACA,GAAIC,CAAAA,GAAG,CAAGL,MAAM,CAACC,MAAP,CAAc,EAAd,CAAkBH,IAAI,CAACI,MAAvB,CAA+B,CAAEE,SAAS,CAAE,IAAb,CAAmBD,OAAO,CAAE,KAA5B,CAA/B,CAAV,CACAJ,KAAK,CAACO,KAAN,CAAc,CAACjB,MAAf,CACA;AACA,MAAOU,CAAAA,KAAK,CAAC,SAAD,CAAZ,CACA,MAAOA,CAAAA,KAAK,CAAC,WAAD,CAAZ,CACAM,GAAG,CAAC3B,KAAJ,CAAYqB,KAAZ,CACA,MAAOM,CAAAA,GAAG,CAAC,SAAD,CAAV,CACA,MAAOA,CAAAA,GAAG,CAAC,WAAD,CAAV,CACA;AACA;AACA,GAAIR,CAAAA,GAAG,oBAAOZ,KAAP,CAAP,CACA,GAAIsB,CAAAA,GAAG,CAAG,CACNL,MAAM,CAAEG,GADF,CAENpB,KAAK,CAAEa,IAAI,CAACb,KAFN,CAGNE,GAAG,CAAE,KAHC,CAAV,CAKAU,GAAG,CAACe,CAAD,CAAH,CAASL,GAAT,CACArB,QAAQ,CAACW,GAAD,CAAR,CACH,CACJ,CAvBD,CAwBA;AACA,GAAIqC,CAAAA,gBAAgB,CAAG,QAAnBA,CAAAA,gBAAmB,EAAM,CACzB,GAAIE,CAAAA,YAAW,CAAG,sBAAM,CACpB,GAAI,CACA,GAAM1B,CAAAA,UAAU,CAAGvC,qBAAqB,EAAxC,CACA,GAAM2D,CAAAA,UAAU,CAAG,GAAIG,CAAAA,WAAJ,CAAgB,CAACvB,UAAD,CAAhB,CAAnB,CACA,MAAO0B,CAAAA,YAAW,cACd,cAAO,KAAK,CAAE,IAAd,CAAoB,GAAG,CAAE,aAAAnD,KAAK,QAAIA,CAAAA,KAAK,CAAC+C,SAAN,CAAkBF,UAAtB,EAA9B,CAAgE,WAAW,KAA3E,CAA4E,QAAQ,KAApF,EADJ,CAGH,CAAC,MAAOO,KAAP,CAAc,CACZ,OACH,CACJ,CAVD,CAWA,MAAOD,CAAAA,YAAW,EAAlB,CACH,CAbD,CAcA;AACA,GAAME,CAAAA,UAAU,CAAG,QAAbA,CAAAA,UAAa,CAACC,IAAD,CAAU,CACzBA,IAAI,CAACC,EAAL,CAAQ,QAAR,2FAAkB,kBAAOC,eAAP,4IACVL,WADU,2FACI,uLACR1B,UADQ,CACKvC,qBAAqB,EAD1B,CAER2D,UAFQ,CAEK,GAAIG,CAAAA,WAAJ,CAAgB,CAACvB,UAAD,CAAhB,CAFL,kBAINgC,YAJM,CAISnE,IAAI,CAACkE,eAAD,CAAkB,EAAlB,CAJb,CAKVC,YAAY,CAACF,EAAb,CAAgB,UAAhB,CAA4B,UAAY,CACpC9C,OAAO,CAAC,IAAD,CAAP,CACH,CAFD,EAGAgD,YAAY,CAACF,EAAb,CAAgB,kBAAhB,CAAoC,UAAY,CAC5C9C,OAAO,CAAC,KAAD,CAAP,CACH,CAFD,EARU,8CAWH,cAAO,WAAW,KAAlB,CAAmB,KAAK,CAAE,KAA1B,CAAiC,GAAG,CAAE,aAAAT,KAAK,QAAIA,CAAAA,KAAK,CAAGA,KAAK,CAAC+C,SAAN,CAAkBS,eAArB,CAAuCX,UAAhD,EAA3C,CAAuG,QAAQ,KAA/G,EAXG,6DAaNC,EAbM,CAaFG,gBAAgB,EAbd,CAcN3B,IAdM,CAcA,CACNL,MAAM,CAAE6B,EADF,CAEN9C,KAAK,CAAE,KAFD,CAGNE,GAAG,CAAE,KAHC,CAdA,CAmBVD,QAAQ,CAAC,SAAAa,KAAK,qCAAQA,KAAR,GAAeQ,IAAf,IAAN,CAAR,CAnBU,sEADJ,kBACV6B,CAAAA,WADU,mEAuBAA,CAAAA,WAAW,EAvBX,QAuBVL,CAvBU,gBAwBVxB,GAxBU,CAwBJ,CACNL,MAAM,CAAE6B,CADF,CAEN9C,KAAK,CAAE,IAFD,CAGNE,GAAG,CAAE,IAHC,CAxBI,CA6BdD,QAAQ,CAAC,SAAAa,KAAK,qCAAQA,KAAR,GAAeQ,GAAf,IAAN,CAAR,CA7Bc,wDAAlB,iEA+BH,CAhCD,CAiCA;AACA,GAAMoC,CAAAA,IAAI,CAAG,QAAPA,CAAAA,IAAO,CAACC,IAAD,CAAO1C,MAAP,CAAkB,CAC3B;AACA,GAAI0C,IAAI,CAACC,SAAL,GAAmB,KAAvB,CAA8B,CAC1B;AACAD,IAAI,CAACJ,EAAL,CAAQ,MAAR,CAAgB,SAAAD,IAAI,CAAI,CACpBA,IAAI,CAACO,MAAL,CAAY5C,MAAZ,EACAoC,UAAU,CAACC,IAAD,CAAV,CACH,CAHD,EAIA;AACA1D,MAAM,CAAC2D,EAAP,CAAU,cAAV,CAA0B,SAAAzC,KAAK,CAAI,CAC/B,GAAIA,KAAK,CAACgD,MAAN,GAAiBhE,EAArB,CAAyB,CACrB,GAAMwD,CAAAA,IAAI,CAAGK,IAAI,CAACL,IAAL,CAAUxC,KAAK,CAAChB,EAAhB,CAAoBmB,MAApB,CAAb,CACAoC,UAAU,CAACC,IAAD,CAAV,CACH,CACJ,CALD,EAMH,CACJ,CAhBD,CAkBA3E,SAAS,CAAC,UAAM,CACZ,GAAMoF,CAAAA,EAAE,CAAG,QAALA,CAAAA,EAAK,EAAM,CACbxD,UAAU,CAACR,MAAD,CAAV,CACAA,MAAM,CAACwD,EAAP,CAAU,MAAV,CAAkB,UAAM,CACpB3D,MAAM,CAACoE,IAAP,CAAY,WAAZ,CAAyB,CAAEF,MAAM,CAAEhE,EAAV,CAAcA,EAAE,CAAEJ,MAAlB,CAA0BuE,CAAC,CAAE,GAA7B,CAAzB,CAA6D,SAACC,QAAD,CAAc,CAAG,CAA9E,EACH,CAFD,EAGA;AACAhC,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC,CAAEC,KAAK,CAAE,KAAT,CAAgBrC,KAAK,CAAEE,GAAvB,CAApC,EAAkEoC,IAAlE,CAAuE,SAAArB,MAAM,CAAI,CAC7EyC,IAAI,CAAC3D,MAAD,CAASkB,MAAT,CAAJ,CACH,CAFD,EAEGuB,KAFH,CAES,SAAAC,GAAG,CAAI,CACZ;AACA,GAAMhB,CAAAA,UAAU,CAAGvC,qBAAqB,EAAxC,CACA,GAAM+B,CAAAA,MAAM,CAAG,GAAI+B,CAAAA,WAAJ,CAAgB,CAACvB,UAAD,CAAhB,CAAf,CACAiC,IAAI,CAAC3D,MAAD,CAASkB,MAAT,CAAJ,CACH,CAPD,EAQH,CAdD,CAeA8C,EAAE,GACL,CAjBQ,CAiBN,CAACjE,EAAD,CAAKC,MAAL,CAjBM,CAAT,CAkBA,mBACI,aAAK,SAAS,CAAC,mBAAf,wBACI,KAAC,UAAD,EAAY,EAAE,CAAEN,KAAK,CAACK,EAAtB,CAA0B,MAAM,CAAEJ,MAAlC,EADJ,cAEI,aAAK,SAAS,CAAC,oBAAf,wBACI,KAAC,UAAD,EAAY,OAAO,CAAE,iBAACoB,KAAD,QAAWrB,CAAAA,KAAK,CAAC0E,OAAN,CAAcrD,KAAd,CAAX,EAArB,EADJ,cAEI,aAAK,SAAS,CAAC,UAAf,wBACI,iCADJ,cAEI,aAAK,SAAS,CAAC,aAAf,wBACI,YACI,GAAG,CAAC,OADR,CAEI,KAAK,CAAEN,IAAI,GAAK,IAAT,CAAgB,CAAE4D,MAAM,CAAE,mCAAV,CAAhB,CAAkE,EAF7E,CAGI,GAAG,CAAC,cAHR,EADJ,cAKI,aAAK,SAAS,CAAC,aAAf,wBACI,KAAC,UAAD,EAAY,OAAO,CAAE,iBAACC,CAAD,QAAO7C,CAAAA,YAAY,EAAnB,EAArB,UACKtB,GAAG,GAAK,IAAR,cAAe,KAAC,OAAD,IAAf,cAA6B,KAAC,UAAD,IADlC,EADJ,cAII,KAAC,UAAD,EAAY,OAAO,CAAE,iBAACmE,CAAD,QAAO3D,CAAAA,eAAe,EAAtB,EAArB,UACKN,MAAM,GAAK,KAAX,CAAmBI,IAAI,GAAK,IAAT,cAAgB,KAAC,YAAD,IAAhB,cAAmC,KAAC,cAAD,IAAtD,cAA2E,KAAC,aAAD,IADhF,EAJJ,GALJ,GAFJ,CAiBQR,KAAK,CAACW,MAAN,CAAe,CAAf,CAAmBX,KAAK,CAACsE,GAAN,CAAU,SAAUxD,KAAV,CAAiBa,CAAjB,CAAoB,CAC7C,mBAAO,aAAK,SAAS,CAAC,aAAf,wBACH,YACI,GAAG,CAAC,OADR,CAEI,KAAK,CAAEnB,IAAI,GAAK,IAAT,CAAgB,CAAE4D,MAAM,CAAE,mCAAV,CAAhB,CAAkE,EAF7E,CAGI,GAAG,CAAC,cAHR,EADG,cAKH,aAAK,SAAS,CAAC,aAAf,WACKtD,KAAK,CAACG,MADX,CAEKH,KAAK,CAACZ,GAFX,cAGI,KAAC,UAAD,EAAY,OAAO,CAAE,iBAACmE,CAAD,QAAOnB,CAAAA,iBAAiB,CAACpC,KAAD,CAAQa,CAAR,CAAxB,EAArB,UACKb,KAAK,CAACZ,GAAN,GAAc,IAAd,cAAqB,KAAC,OAAD,IAArB,cAAmC,KAAC,UAAD,IADxC,EAHJ,cAMI,KAAC,UAAD,EAAY,OAAO,CAAE,iBAACmE,CAAD,QAAO3B,CAAAA,oBAAoB,CAAC5B,KAAD,CAAQa,CAAR,CAA3B,EAArB,UACKb,KAAK,CAACd,KAAN,GAAgB,IAAhB,CAAuBQ,IAAI,GAAK,IAAT,cAAgB,KAAC,YAAD,IAAhB,cAAmC,KAAC,cAAD,IAA1D,cAA+E,KAAC,aAAD,IADpF,EANJ,GALG,GAAkCmB,CAAlC,CAAP,CAgBH,CAjBkB,CAAnB,CAiBK4C,OAAO,CAACC,GAAR,EAlCb,GAFJ,GAFJ,GADJ,CA6CH,CACD,cAAehF,CAAAA,SAAf","sourcesContent":["import React, { useState, useEffect } from 'react'\nimport { getCookie } from '../../../helpers/auth';\nimport socketApp from '../../../socket';\nimport IconButton from '@material-ui/core/IconButton';\nimport \"../../style/call.css\"\nimport VolumeMuteIcon from '@material-ui/icons/VolumeMute';\nimport VolumeUpIcon from '@material-ui/icons/VolumeUp';\nimport VolumeOffIcon from '@material-ui/icons/VolumeOff';\nimport { createEmptyAudioTrack } from '../../../helpers/audio';\nimport SimpleMenu from '../miniChatCom/simpleMenu';\nimport MicIcon from '@material-ui/icons/Mic';\nimport MicOffIcon from '@material-ui/icons/MicOff';\nimport hark from \"hark\"\nimport RenderChat from '../renderChat';\n\n// This function is use for send and view message\nfunction ChatGroup(props) {\n    const userId = getCookie().token;\n    let socket = socketApp.getSocket();\n    const { id, peerJS } = props;\n    const [audio, setAudio] = useState([]);\n    const [mic, setMic] = useState(false)\n    const [volumn, setVolumn] = useState(false)\n    const [oldPeer, setOldPeer] = useState(null)\n    const [talk, setTalk] = useState(false)\n    // turn on or turn off own volumn\n    const handleSetVolumn = async () => {\n        // does any another user in the room\n        if (audio.length !== 0) {\n            setVolumn(!volumn)\n            let arr = []\n            for await (let data of audio) {\n                // copy old object\n                let value = Object.assign({}, data.stream.props, { seleted: false, writeable: true })\n                let old = Object.assign({}, data.stream, { writeable: true, seleted: false })\n                value.muted = !volumn\n                // delete specific key\n                delete value[\"seleted\"]\n                delete value[\"writeable\"]\n                old.props = value\n                delete old[\"seleted\"]\n                delete old[\"writeable\"]\n                // create new object\n                // to handle new data\n                let obj = {\n                    stream: old,\n                    audio: data.audio,\n                    mic: false\n                }\n                arr.push(obj)\n            }\n            setAudio(arr)\n        }\n    }\n    // Turn on or turn off the own mic\n    const handleSetMic = () => {\n        setMic(!mic)\n        if (mic === true) {\n            const audioTrack = createEmptyAudioTrack();\n            let data = oldPeer.connections\n            for (let i = 0; i < audio.length; i++) {\n                let userMic = Object.keys(data)[i]\n                let sender = data[userMic][0].peerConnection.getSenders()[0] || []\n                sender.replaceTrack(audioTrack)\n            }\n        }\n        // else reconnect peer to peer \n        else {\n            navigator.mediaDevices.getUserMedia({ video: false, audio: true }).then(stream => {\n                let data = oldPeer.connections\n                for (let i = 0; i < audio.length; i++) {\n                    let userMic = Object.keys(data)[i]\n                    let sender = data[userMic][0].peerConnection.getSenders()[0]\n                    sender.replaceTrack(stream.getAudioTracks()[0])\n                }\n            }).catch(err => {\n            })\n        }\n    }\n    const handleSetVolumnOther = (value, i) => {\n        // get id the user want to muted\n        let idMuted = Object.keys(oldPeer.connections)[i]\n        let sender = oldPeer.connections[idMuted][0].peerConnection.getSenders()[0] || []\n        const returnAudio = (stream, streamNull) => {\n            let a = (\n                <audio ref={audio => audio ? audio.srcObject = stream : streamNull} playsInline autoPlay />\n            )\n            let obj = {\n                stream: a,\n                audio: false,\n                mic: true\n            }\n            let arr = [...audio]\n            arr[i] = obj\n            setAudio(arr)\n        }\n        if (value.audio === true) {\n            let audioTrack = createEmptyAudioTrack()\n            sender.replaceTrack(audioTrack)\n            const streamNull = new MediaStream([audioTrack]);\n            returnAudio(streamNull, streamNull)\n        } else {\n            navigator.mediaDevices.getUserMedia({ video: false, audio: true }).then(stream => {\n                sender.replaceTrack(stream.getAudioTracks()[0])\n                returnAudio(stream, createNullStream())\n            })\n        }\n    }\n    const handleSetMicOther = (data, i) => {\n        if (audio.length !== 0) {\n            // copy old object\n            let value = Object.assign({}, data.stream.props, { seleted: false, writeable: true })\n            let old = Object.assign({}, data.stream, { writeable: true, seleted: false })\n            value.muted = !volumn\n            // delete specific key\n            delete value[\"seleted\"]\n            delete value[\"writeable\"]\n            old.props = value\n            delete old[\"seleted\"]\n            delete old[\"writeable\"]\n            // create new object\n            // to handle new data\n            let arr = [...audio]\n            let obj = {\n                stream: old,\n                audio: data.audio,\n                mic: false\n            }\n            arr[i] = obj\n            setAudio(arr)\n        }\n    }\n    // create null stream to handle error \n    let createNullStream = () => {\n        let audioStream = () => {\n            try {\n                const audioTrack = createEmptyAudioTrack();\n                const streamNull = new MediaStream([audioTrack]);\n                return audioStream = (\n                    <audio muted={true} ref={audio => audio.srcObject = streamNull} playsInline autoPlay />\n                )\n            } catch (error) {\n                return\n            }\n        }\n        return audioStream()\n    }\n    // new user go to the room\n    const createCall = (call) => {\n        call.on(\"stream\", async (userVideoStream) => {\n            let audioStream = async () => {\n                const audioTrack = createEmptyAudioTrack();\n                const streamNull = new MediaStream([audioTrack]);\n                try {\n                    let speechEvents = hark(userVideoStream, {})\n                    speechEvents.on('speaking', function () {\n                        setTalk(true)\n                    });\n                    speechEvents.on('stopped_speaking', function () {\n                        setTalk(false)\n                    });\n                    return <audio playsInline muted={false} ref={audio => audio ? audio.srcObject = userVideoStream : streamNull} autoPlay />\n                } catch (error) {\n                    let a = createNullStream()\n                    let obj = {\n                        stream: a,\n                        audio: false,\n                        mic: false\n                    }\n                    setAudio(value => [...value, obj])\n                }\n            }\n            let a = await audioStream()\n            let obj = {\n                stream: a,\n                audio: true,\n                mic: true\n            }\n            setAudio(value => [...value, obj])\n        })\n    }\n    // fisrt route of connect peer to peer \n    const plus = (peer, stream) => {\n        // check if that peer is destroyed or not destroy that mean that was created before\n        if (peer.destroyed === false) {\n            // run normally\n            peer.on(\"call\", call => {\n                call.answer(stream)\n                createCall(call)\n            })\n            // recieve from server\n            socket.on(\"user-connect\", value => {\n                if (value.idRoom === id) {\n                    const call = peer.call(value.id, stream)\n                    createCall(call)\n                }\n            })\n        }\n    }\n\n    useEffect(() => {\n        const fn = () => {\n            setOldPeer(peerJS)\n            peerJS.on(\"open\", () => {\n                socket.emit(\"chatVideo\", { idRoom: id, id: userId, g: \"a\" }, (callback) => { })\n            })\n            // get user media\n            navigator.mediaDevices.getUserMedia({ video: false, audio: mic }).then(stream => {\n                plus(peerJS, stream)\n            }).catch(err => {\n                // if user does not accept to stream then create new null stream\n                const audioTrack = createEmptyAudioTrack();\n                const stream = new MediaStream([audioTrack]);\n                plus(peerJS, stream)\n            })\n        }\n        fn()\n    }, [id, peerJS])\n    return (\n        <div className=\"message_container\">\n            <RenderChat id={props.id} userId={userId} />\n            <div className=\"call_div_container\">\n                <SimpleMenu onClick={(value) => props.onClick(value)} />\n                <div className=\"main_mic\">\n                    <p>Voice Chat</p>\n                    <div className=\"user_device\">\n                        <img\n                            alt=\"demom\"\n                            style={talk === true ? { border: \"2px solid rgba(46, 229, 157, 0.4)\" } : {}}\n                            src=\"../demo.jpeg\"></img>\n                        <div className=\"icon_device\">\n                            <IconButton onClick={(e) => handleSetMic()}>\n                                {mic === true ? <MicIcon /> : <MicOffIcon />}\n                            </IconButton>\n                            <IconButton onClick={(e) => handleSetVolumn()}>\n                                {volumn === false ? talk === true ? <VolumeUpIcon /> : <VolumeMuteIcon /> : <VolumeOffIcon />}\n                            </IconButton>\n                        </div>\n                    </div>\n                    {\n                        audio.length > 0 ? audio.map(function (value, i) {\n                            return <div className=\"user_device\" key={i}>\n                                <img\n                                    alt=\"demom\"\n                                    style={talk === true ? { border: \"2px solid rgba(46, 229, 157, 0.4)\" } : {}}\n                                    src=\"../demo.jpeg\"></img>\n                                <div className=\"icon_device\">\n                                    {value.stream}\n                                    {value.mic}\n                                    <IconButton onClick={(e) => handleSetMicOther(value, i)}>\n                                        {value.mic === true ? <MicIcon /> : <MicOffIcon />}\n                                    </IconButton>\n                                    <IconButton onClick={(e) => handleSetVolumnOther(value, i)}>\n                                        {value.audio === true ? talk === true ? <VolumeUpIcon /> : <VolumeMuteIcon /> : <VolumeOffIcon />}\n                                    </IconButton>\n                                </div>\n                            </div>\n                        }) : console.log()\n                    }\n                </div>\n            </div>\n        </div >\n    )\n}\nexport default ChatGroup"]},"metadata":{},"sourceType":"module"}