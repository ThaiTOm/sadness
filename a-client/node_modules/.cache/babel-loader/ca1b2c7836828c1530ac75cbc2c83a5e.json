{"ast":null,"code":"import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import _regeneratorRuntime from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import{jsx as _jsx}from\"react/jsx-runtime\";import _asyncToGenerator from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/duythai/Developer/sadness/a-client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect}from'react';import{getCookie}from'../../../helpers/auth';import IconButton from'@material-ui/core/IconButton';import\"../../style/call.css\";import VolumeMuteIcon from'@material-ui/icons/VolumeMute';import VolumeUpIcon from'@material-ui/icons/VolumeUp';import VolumeOffIcon from'@material-ui/icons/VolumeOff';import{createEmptyAudioTrack}from'../../../helpers/audio';import SimpleMenu from'../miniChatCom/simpleMenu';import MicIcon from'@material-ui/icons/Mic';import MicOffIcon from'@material-ui/icons/MicOff';import hark from\"hark\";import RenderChat from'../renderChat';import socketApp from'../../../socket';// This function is use for send and view message\nfunction ChatCouple(props){var socket=socketApp.getSocket();var userId=getCookie().token;var id=props.id,peerJS=props.peerJS;var _useState=useState(null),_useState2=_slicedToArray(_useState,2),audio=_useState2[0],setAudio=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),mic=_useState4[0],setMic=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),volumn=_useState6[0],setVolumn=_useState6[1];var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),user=_useState8[0],setUser=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),talk=_useState10[0],setTalk=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),accor=_useState12[0],setAccor=_useState12[1];var handleOpenAccor=function handleOpenAccor(){setAccor(!accor);};var handleSetVolumn=function handleSetVolumn(){if(audio){setVolumn(!volumn);var value=Object.assign({},audio.props,{seleted:false,writeable:true});value.muted=!volumn;delete value[\"seleted\"];delete value[\"writeable\"];var old=Object.assign({},audio,{writeable:true,seleted:false});old.props=value;delete old[\"seleted\"];delete old[\"writeable\"];setAudio(old);}};var handleSetMic=function handleSetMic(){// if value send from server is only one person return that else do another\nvar userMic=typeof user===\"string\"?user:user[0]===userId?user[1]:user[0];try{if(mic===true){var audioTrack=createEmptyAudioTrack();var data=peerJS.connections;var sender=data[userMic][0].peerConnection.getSenders()[0];sender.replaceTrack(audioTrack);}else{navigator.mediaDevices.getUserMedia({video:false,audio:true}).then(function(stream){var data=peerJS.connections;var sender=data[userMic][0].peerConnection.getSenders()[0];sender.replaceTrack(stream.getAudioTracks()[0]);}).catch(function(err){});}}catch(error){}setMic(!mic);};var createNullStream=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var audioStream,a;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:audioStream=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var audioTrack,streamNull;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;audioTrack=createEmptyAudioTrack();streamNull=new MediaStream([audioTrack]);audioStream=/*#__PURE__*/_jsx(\"audio\",{muted:true,ref:function ref(audio){return audio.srcObject=streamNull;},playsInline:true,autoPlay:true});_context.next=9;break;case 6:_context.prev=6;_context.t0=_context[\"catch\"](0);return _context.abrupt(\"return\");case 9:case\"end\":return _context.stop();}}},_callee,null,[[0,6]]);}));return function audioStream(){return _ref2.apply(this,arguments);};}();_context2.next=3;return audioStream();case 3:a=_context2.sent;setAudio(a);case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function createNullStream(){return _ref.apply(this,arguments);};}();var createCall=function createCall(call){call.on(\"stream\",/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(userVideoStream){var audioStream,a;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:audioStream=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var audioTrack,streamNull,speechEvents;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:audioTrack=createEmptyAudioTrack();streamNull=new MediaStream([audioTrack]);speechEvents=hark(userVideoStream,{});speechEvents.on('speaking',function(){setTalk(true);});speechEvents.on('stopped_speaking',function(){setTalk(false);});_context3.prev=5;return _context3.abrupt(\"return\",/*#__PURE__*/_jsx(\"audio\",{playsInline:true,muted:false,ref:function ref(audio){return audio?audio.srcObject=userVideoStream:streamNull;},autoPlay:true}));case 9:_context3.prev=9;_context3.t0=_context3[\"catch\"](5);createNullStream();case 12:case\"end\":return _context3.stop();}}},_callee3,null,[[5,9]]);}));return function audioStream(){return _ref4.apply(this,arguments);};}();_context4.next=3;return audioStream();case 3:a=_context4.sent;setAudio(a);case 5:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x){return _ref3.apply(this,arguments);};}());};var plus=function plus(peer,stream){// check if that peer is destroyed or not destroy that mean that was created before\nif(peer.destroyed===false){// run normally\npeer.on(\"call\",function(call){call.answer(stream);createCall(call);});socket.on(\"user-connect\",function(value){if(value.idRoom===id){console.log(id);var call=peer.call(value.id,stream);setUser(value.id);createCall(call);}});}else{createNullStream();}};// if we join another room then delete old peer connections \nuseEffect(function(){peerJS.on(\"open\",function(){socket.emit(\"chatVideo\",{idRoom:id,id:userId,g:null},function(callback){setUser(callback);});});// get user media\nnavigator.mediaDevices.getUserMedia({video:false,audio:false}).then(function(stream){plus(peerJS,stream);}).catch(function(err){// if user does not accept to stream then create new null stream\nvar audioTrack=createEmptyAudioTrack();var stream=new MediaStream([audioTrack]);plus(peerJS,stream);});},[socket,id,peerJS]);return/*#__PURE__*/_jsxs(\"div\",{className:\"message_container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"call_div_container\",children:[/*#__PURE__*/_jsx(SimpleMenu,{onClick:function onClick(value){return props.onClick(value);}}),/*#__PURE__*/_jsxs(\"div\",{className:\"main_mic\",children:[/*#__PURE__*/_jsx(\"p\",{onClick:handleOpenAccor,className:accor===true?\"accordion active\":\"accordion\",children:\"Voice Chat\"}),/*#__PURE__*/_jsx(\"div\",{style:accor===true?{maxHeight:\"200px\"}:{maxHeight:null},className:\"panel\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"user_device\",children:[/*#__PURE__*/_jsx(\"img\",{alt:\"demom\",src:\"../demo.jpeg\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"icon_device\",children:[audio,/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(e){return handleSetMic(!mic);},children:mic===true?/*#__PURE__*/_jsx(MicIcon,{}):/*#__PURE__*/_jsx(MicOffIcon,{})}),/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(e){return handleSetVolumn();},children:volumn===false?talk===true?/*#__PURE__*/_jsx(VolumeUpIcon,{}):/*#__PURE__*/_jsx(VolumeMuteIcon,{}):/*#__PURE__*/_jsx(VolumeOffIcon,{})})]})]})}),audio?/*#__PURE__*/_jsxs(\"div\",{className:\"user_device\",children:[/*#__PURE__*/_jsx(\"img\",{alt:\"avatar\",style:talk===true?{border:\"2px solid rgba(46, 229, 157, 0.4)\"}:{},src:\"../demo.jpeg\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"icon_device\",children:[audio,/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(e){return handleSetVolumn();},children:volumn===false?talk===true?/*#__PURE__*/_jsx(VolumeUpIcon,{}):/*#__PURE__*/_jsx(VolumeMuteIcon,{}):/*#__PURE__*/_jsx(VolumeOffIcon,{})})]})]}):/*#__PURE__*/_jsx(_Fragment,{})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"message_container_div\",children:/*#__PURE__*/_jsx(RenderChat,{id:id,userId:userId})})]});}export default ChatCouple;","map":{"version":3,"sources":["/home/duythai/Developer/sadness/a-client/src/component/chatComponent/miniChatCom/chatCouple.js"],"names":["React","useState","useEffect","getCookie","IconButton","VolumeMuteIcon","VolumeUpIcon","VolumeOffIcon","createEmptyAudioTrack","SimpleMenu","MicIcon","MicOffIcon","hark","RenderChat","socketApp","ChatCouple","props","socket","getSocket","userId","token","id","peerJS","audio","setAudio","mic","setMic","volumn","setVolumn","user","setUser","talk","setTalk","accor","setAccor","handleOpenAccor","handleSetVolumn","value","Object","assign","seleted","writeable","muted","old","handleSetMic","userMic","audioTrack","data","connections","sender","peerConnection","getSenders","replaceTrack","navigator","mediaDevices","getUserMedia","video","then","stream","getAudioTracks","catch","err","error","createNullStream","audioStream","streamNull","MediaStream","srcObject","a","createCall","call","on","userVideoStream","speechEvents","plus","peer","destroyed","answer","idRoom","console","log","emit","g","callback","onClick","maxHeight","e","border"],"mappings":"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","sourcesContent":["import React, { useState, useEffect } from 'react'\nimport { getCookie } from '../../../helpers/auth';\nimport IconButton from '@material-ui/core/IconButton';\nimport \"../../style/call.css\"\nimport VolumeMuteIcon from '@material-ui/icons/VolumeMute';\nimport VolumeUpIcon from '@material-ui/icons/VolumeUp';\nimport VolumeOffIcon from '@material-ui/icons/VolumeOff';\nimport { createEmptyAudioTrack } from '../../../helpers/audio';\nimport SimpleMenu from '../miniChatCom/simpleMenu';\nimport MicIcon from '@material-ui/icons/Mic';\nimport MicOffIcon from '@material-ui/icons/MicOff';\nimport hark from \"hark\"\nimport RenderChat from '../renderChat';\nimport socketApp from '../../../socket';\n\n// This function is use for send and view message\nfunction ChatCouple(props) {\n    let socket = socketApp.getSocket();\n    const userId = getCookie().token;\n    const { id, peerJS } = props;\n    const [audio, setAudio] = useState(null);\n    const [mic, setMic] = useState(false)\n    const [volumn, setVolumn] = useState(false)\n    const [user, setUser] = useState(null)\n    const [talk, setTalk] = useState(false)\n    const [accor, setAccor] = useState(false)\n\n    const handleOpenAccor = () => {\n        setAccor(!accor)\n    }\n\n    const handleSetVolumn = () => {\n        if (audio) {\n            setVolumn(!volumn)\n            let value = Object.assign({}, audio.props, { seleted: false, writeable: true })\n            value.muted = !volumn\n            delete value[\"seleted\"]\n            delete value[\"writeable\"]\n            let old = Object.assign({}, audio, { writeable: true, seleted: false })\n            old.props = value\n            delete old[\"seleted\"]\n            delete old[\"writeable\"]\n            setAudio(old)\n        }\n    }\n\n    const handleSetMic = () => {\n        // if value send from server is only one person return that else do another\n        let userMic = typeof user === \"string\" ? user : user[0] === userId ? user[1] : user[0]\n        try {\n            if (mic === true) {\n                const audioTrack = createEmptyAudioTrack();\n                let data = peerJS.connections\n                let sender = data[userMic][0].peerConnection.getSenders()[0]\n                sender.replaceTrack(audioTrack)\n            }\n            else {\n                navigator.mediaDevices.getUserMedia({ video: false, audio: true }).then(stream => {\n                    let data = peerJS.connections\n                    let sender = data[userMic][0].peerConnection.getSenders()[0]\n                    sender.replaceTrack(stream.getAudioTracks()[0])\n                }).catch(err => {\n                })\n            }\n        } catch (error) {\n        }\n        setMic(!mic)\n    }\n\n    let createNullStream = async () => {\n        let audioStream = async () => {\n            try {\n                const audioTrack = createEmptyAudioTrack();\n                const streamNull = new MediaStream([audioTrack]);\n                audioStream = (\n                    <audio muted={true} ref={audio => audio.srcObject = streamNull} playsInline autoPlay />\n                )\n            } catch (error) {\n                return\n            }\n        }\n        let a = await audioStream()\n        setAudio(a)\n    }\n\n    const createCall = (call) => {\n        call.on(\"stream\", async (userVideoStream) => {\n            let audioStream = async () => {\n                const audioTrack = createEmptyAudioTrack();\n                const streamNull = new MediaStream([audioTrack]);\n                let speechEvents = hark(userVideoStream, {})\n                speechEvents.on('speaking', function () {\n                    setTalk(true)\n                });\n                speechEvents.on('stopped_speaking', function () {\n                    setTalk(false)\n                });\n                try {\n                    return <audio playsInline muted={false} ref={audio => audio ? audio.srcObject = userVideoStream : streamNull\n                    } autoPlay />\n                } catch (error) {\n                    createNullStream()\n                }\n            }\n            let a = await audioStream()\n            setAudio(a)\n        })\n    }\n\n    const plus = (peer, stream) => {\n        // check if that peer is destroyed or not destroy that mean that was created before\n        if (peer.destroyed === false) {\n            // run normally\n            peer.on(\"call\", call => {\n                call.answer(stream)\n                createCall(call)\n            })\n            socket.on(\"user-connect\", value => {\n                if (value.idRoom === id) {\n                    console.log(id)\n                    const call = peer.call(value.id, stream)\n                    setUser(value.id)\n                    createCall(call)\n                }\n\n            })\n        } else {\n            createNullStream()\n        }\n    }\n\n    // if we join another room then delete old peer connections \n\n    useEffect(() => {\n        peerJS.on(\"open\", () => {\n            socket.emit(\"chatVideo\", { idRoom: id, id: userId, g: null }, (callback) => {\n                setUser(callback)\n            })\n        })\n        // get user media\n        navigator.mediaDevices.getUserMedia({ video: false, audio: false }).then(stream => {\n            plus(peerJS, stream)\n        }).catch(err => {\n            // if user does not accept to stream then create new null stream\n            const audioTrack = createEmptyAudioTrack();\n            const stream = new MediaStream([audioTrack]);\n            plus(peerJS, stream)\n        })\n    }, [socket, id, peerJS])\n\n    return (\n        <div className=\"message_container\">\n            <div className=\"call_div_container\">\n                <SimpleMenu onClick={(value) => props.onClick(value)} />\n                <div className=\"main_mic\">\n                    <p onClick={handleOpenAccor} className={accor === true ? \"accordion active\" : \"accordion\"}>Voice Chat</p>\n                    <div style={accor === true ? { maxHeight: \"200px\" } : { maxHeight: null }} className=\"panel\">\n                        <div className=\"user_device\">\n                            <img\n                                alt=\"demom\"\n                                src=\"../demo.jpeg\"></img>\n                            <div className=\"icon_device\">\n                                {audio}\n                                <IconButton onClick={(e) => handleSetMic(!mic)}>\n                                    {mic === true ? <MicIcon /> : <MicOffIcon />}\n                                </IconButton>\n                                <IconButton onClick={(e) => handleSetVolumn()}>\n                                    {volumn === false ? talk === true ? <VolumeUpIcon /> : <VolumeMuteIcon /> : <VolumeOffIcon />}\n                                </IconButton>\n                            </div>\n                        </div>\n                    </div>\n                    {\n                        audio ? <div className=\"user_device\">\n                            <img\n                                alt=\"avatar\"\n                                style={talk === true ? { border: \"2px solid rgba(46, 229, 157, 0.4)\" } : {}}\n                                src=\"../demo.jpeg\"></img>\n                            <div className=\"icon_device\">\n                                {audio}\n                                <IconButton onClick={(e) => handleSetVolumn()}>\n                                    {volumn === false ? talk === true ? <VolumeUpIcon /> : <VolumeMuteIcon /> : <VolumeOffIcon />}\n                                </IconButton>\n                            </div>\n                        </div> : <></>\n                    }\n                </div>\n            </div>\n            <div className=\"message_container_div\">\n                <RenderChat id={id} userId={userId} />\n            </div>\n        </div >\n    )\n}\nexport default ChatCouple"]},"metadata":{},"sourceType":"module"}